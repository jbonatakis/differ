name: Release

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  release:
    name: Build And Upload Assets
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, darwin]
        goarch: [amd64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build release artifact
        run: |
          tag="${{ github.event.release.tag_name }}"
          if [[ "$tag" != v* ]]; then
            echo "Release tag must start with 'v' (for example v1.2.3). Got: $tag" >&2
            exit 1
          fi

          artifact="differ-${tag}-${{ matrix.goos }}-${{ matrix.goarch }}"
          out_dir="dist/${artifact}"
          mkdir -p "$out_dir"

          GOOS="${{ matrix.goos }}" \
          GOARCH="${{ matrix.goarch }}" \
          CGO_ENABLED=0 \
          go build -trimpath -ldflags "-s -w" -o "${out_dir}/differ" ./cmd/differ

          tar -C "$out_dir" -czf "dist/${artifact}.tar.gz" differ
          sha256sum "dist/${artifact}.tar.gz" > "dist/${artifact}.tar.gz.sha256"

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ github.event.release.tag_name }}"
          artifact="differ-${tag}-${{ matrix.goos }}-${{ matrix.goarch }}"
          gh release upload "$tag" \
            "dist/${artifact}.tar.gz" \
            "dist/${artifact}.tar.gz.sha256" \
            --clobber

  update-homebrew:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    needs: release
    if: github.event.release.draft == false
    steps:
      - name: Checkout homebrew tap
        uses: actions/checkout@v4
        with:
          repository: jbonatakis/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Extract version
        run: |
          tag="${{ github.event.release.tag_name }}"
          if [[ "$tag" != v* ]]; then
            echo "Release tag must start with 'v' (for example v1.2.3). Got: $tag" >&2
            exit 1
          fi
          echo "TAG=$tag" >> "$GITHUB_ENV"
          echo "VERSION=${tag#v}" >> "$GITHUB_ENV"

      - name: Download checksums
        run: |
          base="https://github.com/${{ github.repository }}/releases/download/${TAG}"

          curl -fsSL "$base/differ-${TAG}-darwin-arm64.tar.gz.sha256" | awk '{print $1}' > darwin_arm64
          curl -fsSL "$base/differ-${TAG}-darwin-amd64.tar.gz.sha256" | awk '{print $1}' > darwin_amd64
          curl -fsSL "$base/differ-${TAG}-linux-arm64.tar.gz.sha256" | awk '{print $1}' > linux_arm64
          curl -fsSL "$base/differ-${TAG}-linux-amd64.tar.gz.sha256" | awk '{print $1}' > linux_amd64

      - name: Locate formula file
        run: |
          if [[ -f tap/Formula/differ.rb ]]; then
            echo "FORMULA_REL=Formula/differ.rb" >> "$GITHUB_ENV"
          elif [[ -f tap/differ.rb ]]; then
            echo "FORMULA_REL=differ.rb" >> "$GITHUB_ENV"
          else
            echo "Could not find differ formula file in tap repo" >&2
            find tap -maxdepth 3 -name 'differ.rb' -print
            exit 1
          fi

      - name: Update formula
        run: |
          formula="tap/${FORMULA_REL}"

          sed -i "s/version \".*\"/version \"${VERSION}\"/" "$formula"

          tmp_formula="$(mktemp)"
          awk \
            -v darwin_arm64="$(cat darwin_arm64)" \
            -v darwin_amd64="$(cat darwin_amd64)" \
            -v linux_arm64="$(cat linux_arm64)" \
            -v linux_amd64="$(cat linux_amd64)" '
            /^[[:space:]]*url "[^"]+"/ {
              artifact = ""
              if ($0 ~ /darwin-arm64/) artifact = "darwin_arm64"
              else if ($0 ~ /darwin-amd64/) artifact = "darwin_amd64"
              else if ($0 ~ /linux-arm64/) artifact = "linux_arm64"
              else if ($0 ~ /linux-amd64/) artifact = "linux_amd64"
            }
            /^[[:space:]]*sha256 "[^"]+"/ && artifact != "" {
              if (artifact == "darwin_arm64") {
                sub(/sha256 "[^"]+"/, "sha256 \"" darwin_arm64 "\"")
                seen_darwin_arm64 = 1
              } else if (artifact == "darwin_amd64") {
                sub(/sha256 "[^"]+"/, "sha256 \"" darwin_amd64 "\"")
                seen_darwin_amd64 = 1
              } else if (artifact == "linux_arm64") {
                sub(/sha256 "[^"]+"/, "sha256 \"" linux_arm64 "\"")
                seen_linux_arm64 = 1
              } else if (artifact == "linux_amd64") {
                sub(/sha256 "[^"]+"/, "sha256 \"" linux_amd64 "\"")
                seen_linux_amd64 = 1
              }
              artifact = ""
            }
            { print }
            END {
              if (!(seen_darwin_arm64 && seen_darwin_amd64 && seen_linux_arm64 && seen_linux_amd64)) {
                printf("Expected darwin/linux amd64/arm64 url+sha256 blocks in %s\n", FILENAME) > "/dev/stderr"
                exit 1
              }
            }
          ' "$formula" > "$tmp_formula"
          mv "$tmp_formula" "$formula"

      - name: Commit and push
        run: |
          cd tap
          git config user.name "differ-bot"
          git config user.email "actions@github.com"

          git add "${FORMULA_REL}"
          if git diff --cached --quiet; then
            echo "No formula changes to commit"
            exit 0
          fi

          git commit -m "differ ${VERSION}"
          git push
