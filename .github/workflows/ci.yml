name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

defaults:
  run:
    working-directory: .

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Format check
        run: test -z "$(gofmt -l .)"

      - name: Build
        run: go build ./...

      - name: Test
        run: go test ./...

  pr-differ-comment:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install differ
        run: |
          go install ./cmd/differ
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Generate differ report
        run: |
          differ \
            --base "${{ github.event.pull_request.base.sha }}" \
            --head "${{ github.event.pull_request.head.sha }}" \
            --format json > differ.json

      - name: Upsert differ breakdown comment
        if: github.event.pull_request.head.repo.fork == false
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const marker = "<!-- differ-breakdown -->";
            const report = JSON.parse(fs.readFileSync("differ.json", "utf8"));
            const total = report.total || {};
            const rangeBase = report.meta?.base || "base";
            const rangeHead = report.meta?.head || "head";
            const escapePipes = (value) => String(value).replace(/\|/g, "\\|");
            const categories = Object.entries(report.by_category || {})
              .map(([name, stats]) => ({ name, ...stats }))
              .sort((a, b) => (b.churn || 0) - (a.churn || 0));
            const topFiles = [...(report.by_file || [])]
              .sort((a, b) => (b.churn || 0) - (a.churn || 0))
              .slice(0, 10);

            const lines = [
              marker,
              "## `differ` Breakdown",
              "",
              `Range: \`${rangeBase}...${rangeHead}\``,
              "",
              "| Metric | Value |",
              "| --- | ---: |",
              `| Files changed | ${total.files ?? 0} |`,
              `| Lines added | ${total.added ?? 0} |`,
              `| Lines deleted | ${total.deleted ?? 0} |`,
              `| Churn | ${total.churn ?? 0} |`,
              ""
            ];

            if (categories.length === 0) {
              lines.push("_No changed files detected by differ._", "");
            } else {
              lines.push("| Category | Files | + | - | Churn |");
              lines.push("| --- | ---: | ---: | ---: | ---: |");
              for (const category of categories) {
                lines.push(
                  `| ${escapePipes(category.name)} | ${category.file_count ?? 0} | ${category.added ?? 0} | ${category.deleted ?? 0} | ${category.churn ?? 0} |`
                );
              }
              lines.push("");
            }

            if (topFiles.length > 0) {
              lines.push("Top files by churn:", "");
              lines.push("| File | Category | + | - | Churn |");
              lines.push("| --- | --- | ---: | ---: | ---: |");
              for (const file of topFiles) {
                lines.push(
                  `| \`${escapePipes(file.path || "")}\` | ${escapePipes(file.category || "")} | ${file.added ?? 0} | ${file.deleted ?? 0} | ${file.churn ?? 0} |`
                );
              }
              lines.push("");
            }

            lines.push("_Generated by CI using `differ`._");
            const body = lines.join("\n");

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100
            });
            const existing = comments.find(
              (comment) => comment.user?.type === "Bot" && comment.body?.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body
              });
            }
